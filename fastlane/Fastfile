default_platform(:mac)

TEMP_KEYCHAIN_USER = ENV["TEMP_KEYCHAIN_USER"]
TEMP_KEYCHAIN_PASSWORD = ENV["TEMP_KEYCHAIN_PASSWORD"]
APPLE_ISSUER_ID = ENV["APPLE_ISSUER_ID"]
APPLE_KEY_ID = ENV["APPLE_KEY_ID"]
APPLE_KEY_CONTENT = ENV["APPLE_KEY_CONTENT"]

def init_credentials()
  create_keychain(
    name: TEMP_KEYCHAIN_USER,
    password: TEMP_KEYCHAIN_PASSWORD,
    unlock: false,
    default_keychain: true,
    timeout: 0
  )

  return app_store_connect_api_key(
    key_id: APPLE_KEY_ID,
    issuer_id: APPLE_ISSUER_ID,
    key_content: APPLE_KEY_CONTENT,            
    duration: 1200,            
    in_house: false
  )
end

platform :mac do
  lane :sign do
    api_key = init_credentials()
    cert(
      api_key: api_key,
      keychain_password: TEMP_KEYCHAIN_PASSWORD
    )
  end
end
